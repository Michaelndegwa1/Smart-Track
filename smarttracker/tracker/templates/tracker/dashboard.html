from datetime import timedelta
from django.utils import timezone
from django.db.models import Sum, Avg
from rest_framework.decorators import api_view
from rest_framework.response import Response

from .models import Session

# ----------------------
# Utility functions
# ----------------------

def today_key():
    return timezone.localdate()

def serialize_session(session):
    """Helper to convert a Session instance to dict."""
    return {
        "id": session.id,
        "platform": session.platform,
        "time": round(session.time_seconds, 1),
        "date": str(session.date),
        "start_ts": session.start_ts.isoformat(),
        "end_ts": session.end_ts.isoformat(),
    }


# ----------------------
# API Views
# ----------------------

@api_view(["GET"])
def sessions_today(request):
    """Return all sessions for today."""
    today = today_key()
    sessions = Session.objects.filter(date=today).order_by("start_ts")
    data = [serialize_session(s) for s in sessions]
    return Response(data)


@api_view(["GET"])
def sessions_recent(request):
    """Return recent sessions (default limit = 10)."""
    limit = int(request.query_params.get("limit", 10))
    sessions = Session.objects.all().order_by("-end_ts")[:limit]
    data = [serialize_session(s) for s in sessions]
    return Response(data)


@api_view(["GET"])
def summary_today(request):
    """Return total seconds spent per platform for today."""
    today = today_key()
    totals = (
        Session.objects.filter(date=today)
        .values("platform")
        .annotate(total=Sum("time_seconds"))
    )
    result = {t["platform"]: round(t["total"] or 0, 1) for t in totals}
    return Response({"date": str(today), "totals": result})


@api_view(["GET"])
def summary_last7(request):
    """Return totals (seconds) per platform for the last 7 days."""
    end = timezone.localdate()
    start = end - timedelta(days=6)
    qs = (
        Session.objects.filter(date__range=(start, end))
        .values("date", "platform")
        .annotate(seconds=Sum("time_seconds"))
        .order_by("date")
    )
    data = [
        {"date": str(row["date"]), "platform": row["platform"], "seconds": round(row["seconds"] or 0, 1)}
        for row in qs
    ]
    return Response(data)


@api_view(["GET"])
def avg_hours_per_day(request):
    """Return average hours per day per platform."""
    platforms = ["facebook", "instagram", "x", "tiktok"]
    total_days = Session.objects.values("date").distinct().count() or 1

    result = {}
    for p in platforms:
        total_seconds = Session.objects.filter(platform=p).aggregate(Sum("time_seconds"))["time_seconds__sum"] or 0
        result[p] = round((total_seconds / total_days) / 3600.0, 2)

    return Response(result)


@api_view(["GET"])
def total_all(request):
    """Return all-time total seconds and grand total."""
    totals = (
        Session.objects.values("platform")
        .annotate(total=Sum("time_seconds"))
    )
    platform_totals = {t["platform"]: float(t["total"] or 0) for t in totals}
    grand = sum(platform_totals.values())
    return Response({"totals_sec": platform_totals, "grand_total_sec": grand})
